# Caddyfile - NOC Monitoring Production Setup
# Server: Dynamic IP

# Ganti IP spesifik menjadi :80 agar Caddy listen di IP berapapun yang didapat DHCP
:80 {
    # Main reverse proxy ke Gunicorn (Flask app)
    reverse_proxy 127.0.0.1:5000 {
        # CRITICAL headers untuk Socket.IO handshake
        # Ubah Host ke {host} agar Flask mengenali IP asli server (bukan localhost)
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}

        # Timeout tuning untuk HTTP long-polling
        transport http {
            dial_timeout 10s
            read_timeout 60s
            write_timeout 60s
            keepalive 30s
        }
    }

    # Explicit logging
    log {
        output file /var/log/caddy/noc-access.log {
            roll_size 10mb
            roll_keep 5
            roll_keep_for 720h
        }
        format json
        level INFO
    }

    # Compression
    encode gzip

    # Security headers
    header {
        # NOTE: CSP dihapus dari sini karena sudah di-handle oleh app.py
        # Menghindari konflik double-header atau syntax error.
        
        -Server
        X-Content-Type-Options "nosniff"
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        Referrer-Policy "strict-origin-when-cross-origin"
    }
}